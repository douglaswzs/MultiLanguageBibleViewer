import toJyutping from"https://unpkg.com/to-jyutping@3.1.1?module";const availableBibles={ar_svd:"Arabic 🇸🇦",zh_cuv:"Chinese Union Version 🇭🇰",zh_ncv:"New Chinese Version 🇹🇼",de_schlachter:"German 🇩🇪",el_greek:"Modern Greek 🇬🇷",en_bbe:"Basic English 🇺🇸",en_kjv:"King James Version 🇺🇸",eo_esperanto:"Esperanto 🌍",es_rvr:"Reina Valera 🇪🇸",fi_finnish:"Finnish Bible 🇫🇮",fi_pr:"Pyhä Raamattu 🇫🇮",fr_apee:"Le Bible de l'Épée 🇫🇷",ko_ko:"Korean Version 🇰🇷",pt_aa:"Almeida Revisada Imprensa Bíblica 🇵🇹",pt_acf:"Almeida Corrigida e Revisada Fiel 🇧🇷",pt_nvi:"Nova Versão Internacional 🇧🇷",ro_cornilescu:"Versiunea Dumitru Cornilescu 🇷🇴",ru_synodal:"Синодальный перевод 🇷🇺",vi_vietnamese:"Tiếng Việt 🇻🇳"},selects=["lang1Select","lang2Select","lang3Select"],bibleCache={};let pronunciationMode=localStorage.getItem("pronunciationMode")||"both",isHorizontal="horizontal"===localStorage.getItem("layoutMode");const prefersDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;let currentTheme=localStorage.getItem("theme")||(prefersDark?"dark":"light");const bibleHeader=document.getElementById("bibleHeader"),bibleBody=document.getElementById("bibleBody"),bibleTable=document.getElementById("bibleTable"),lang1Select=document.getElementById("lang1Select"),lang2Select=document.getElementById("lang2Select"),lang3Select=document.getElementById("lang3Select"),themeToggle=document.getElementById("themeToggle"),togglePronunciationButton=document.getElementById("togglePronunciation"),verseJump=document.getElementById("verseJump"),jumpBtn=document.getElementById("jumpBtn"),layoutToggleBtn=document.getElementById("toggleLayout"),copyPermalink=document.getElementById("copyPermalink"),chapterSelect=document.getElementById("chapterSelect"),bookSelect=document.getElementById("bookSelect"),filterToggle=document.getElementById("filterToggle"),filterPopup=document.getElementById("categoryFilterPopup"),soundLabels={on:"🔊 Sound",off:"🔇 Muted"},layoutLabels={horizontal:"Toggle: Horizontal",side:"Toggle: Side-by-Side"},pronunciationLabels={jyutping:"Jyutping",pinyin:"Pinyin",both:"Jyutping + Pinyin",none:"None"},themeLabels={dark:"☀️",light:"🌙"};function populateSelectors(){selects.forEach((e=>{const t=document.getElementById(e);for(const e in availableBibles){const n=document.createElement("option");n.value=e,n.textContent=availableBibles[e],t.appendChild(n)}}))}function populateBookSelect(e){bookSelect.innerHTML="",e.forEach((e=>{const t=document.createElement("option");t.value=e.abbrev,t.textContent=e.name,bookSelect.appendChild(t)}))}function populateChapterSelect(e){chapterSelect.innerHTML="",e.chapters.forEach(((e,t)=>{const n=document.createElement("option");n.value=t,n.textContent=`Chapter ${t+1}`,chapterSelect.appendChild(n)}))}function getQueryParams(){const e=new URLSearchParams(window.location.search);return{lang1:e.get("lang1"),lang2:e.get("lang2"),lang3:e.get("lang3"),book:e.get("book"),chapter:e.get("chapter"),verse:e.get("verse")}}function applyQueryParams(){const{lang1:e,lang2:t,lang3:n,book:o,chapter:a,verse:l}=getQueryParams();e&&(lang1Select.value=e),t&&(lang2Select.value=t),n&&(lang3Select.value=n),o&&localStorage.setItem("bookSelect",o),a&&localStorage.setItem("chapterSelect",parseInt(a)-1),l&&setTimeout((()=>{verseJump.value=`${a}:${l}`,jumpToVerse()}),1e3)}async function loadBibleData(){bibleHeader.innerHTML="";const e=document.createElement("tr");let t=null;const n=[];for(let o=0;o<selects.length;o++){const a=document.getElementById(selects[o]).value;if(a)try{if(!bibleCache[a]){const e=await fetch(`https://raw.githubusercontent.com/thiagobodruk/bible/master/json/${a}.json`);bibleCache[a]=await e.json()}const o=bibleCache[a];if(!t){t=o,populateBookSelect(t);const e=getQueryParams().book||localStorage.getItem("bookSelect")||t[0].abbrev;bookSelect.value=e;const n=o.find((t=>t.abbrev===e));if(n){populateChapterSelect(n);const e=getQueryParams().chapter,t=e?parseInt(e)-1:parseInt(localStorage.getItem("chapterSelect"))||0;chapterSelect.value=t}}const l=bookSelect.value||t[0].abbrev,c=o.find((e=>e.abbrev===l)),r=document.createElement("th");r.textContent=availableBibles[a],e.appendChild(r),n.push({...c,langKey:a})}catch(e){console.error(`Error loading ${a}:`,e),n.push(null)}else n.push(null)}bibleHeader.appendChild(e),renderChapter(n),checkZhLangSelected()}function createVerseLineWithTTS(e,t,n=null){const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",o.style.gap="12px";const a=document.createElement("span");a.textContent=n??e;const l=document.createElement("button");return l.textContent="🔊",l.title="Read aloud",l.style.cursor="pointer",l.onclick=()=>speakText(e,t),o.appendChild(a),o.appendChild(l),o}function renderChapter(e){const t=parseInt(chapterSelect.value)||0,n=document.getElementById("bibleBody");n.innerHTML="";const o=Math.max(...e.map((e=>e?.chapters[t]?.length||0)));for(let a=0;a<o;a++){const o=document.createElement("tr");o.setAttribute("data-chapter-verse",`${t+1}:${a+1}`),o.setAttribute("data-verse",`${a+1}`),e.forEach((e=>{if(!e)return;const n=document.createElement("td");if(e&&e.chapters[t][a]){const o=e.chapters[t][a],l=(document.createElement("div"),createVerseLineWithTTS(`${a+1}: ${o}`,e.langKey));if(n.appendChild(l),"zh_cuv"===e.langKey||"zh_ncv"===e.langKey){const e="pinyin"===pronunciationMode||"both"===pronunciationMode;if("jyutping"===pronunciationMode||"both"===pronunciationMode){const e=createVerseLineWithTTS(o,"zh-HK",toJyutping.getJyutpingText(o));e.className="jyutping",n.appendChild(e)}if(e&&window.pinyinPro&&window.pinyinPro.pinyin){const e=document.createElement("div");e.textContent=window.pinyinPro.pinyin(o),e.className="pinyin",n.appendChild(e)}}}o.appendChild(n)})),n.appendChild(o)}document.querySelectorAll("#bibleBody tr").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-verse");localStorage.setItem("selectedVerse",t);const n=e.getAttribute("data-chapter-verse");localStorage.setItem("selectedChapterVerse",n),document.querySelectorAll(".highlighted").forEach((e=>e.classList.remove("highlighted"))),e.classList.add("highlighted")}));const t=localStorage.getItem("selectedChapterVerse");if(t){const e=document.querySelector(`tr[data-chapter-verse='${t}']`);e&&e.classList.add("highlighted")}}))}function onBookOrChapterChange(){const e=bookSelect.value;localStorage.setItem("bookSelect",e);renderChapter(selects.map((t=>{const n=document.getElementById(t).value,o=n&&bibleCache[n]?bibleCache[n].find((t=>t.abbrev===e)):null;return o?{...o,langKey:n}:null})))}function checkZhLangSelected(){const e=selects.some((e=>{const t=document.getElementById(e).value;return"zh_cuv"===t||"zh_ncv"===t}));togglePronunciationButton.style.display=e?"inline":"none"}function jumpToVerse(){const e=verseJump.value.trim(),t=e.match(/^(\w+)\s+(\d+):(\d+)$/i),n=e.match(/^(\d+):(\d+)$/),o=e.match(/^(\w+)\s+(\d+)$/i);if(t){const e=t[1].toLowerCase(),n=parseInt(t[2])-1,o=parseInt(t[3]),a=lang1Select.value;if(!a||!bibleCache[a])return;const l=bibleCache[a].find((t=>t.name.toLowerCase()===e||t.abbrev.toLowerCase()===e));if(!l)return;bookSelect.value=l.abbrev,localStorage.setItem("bookSelect",l.abbrev),populateChapterSelect(l),chapterSelect.value=n,localStorage.setItem("chapterSelect",n),onBookOrChapterChange(),setTimeout((()=>{const e=`${n+1}:${o}`;document.querySelectorAll(".highlighted").forEach((e=>e.classList.remove("highlighted")));const t=document.querySelector(`tr[data-chapter-verse='${e}']`);t&&(t.scrollIntoView({behavior:"smooth",block:"start"}),t.classList.add("highlighted"))}),200)}else if(n){const e=parseInt(n[1])-1,t=parseInt(n[2]);chapterSelect.value=e,localStorage.setItem("chapterSelect",e),onBookOrChapterChange(),setTimeout((()=>{const n=`${e+1}:${t}`;document.querySelectorAll(".highlighted").forEach((e=>e.classList.remove("highlighted")));const o=document.querySelector(`tr[data-chapter-verse='${n}']`);o&&(o.scrollIntoView({behavior:"smooth",block:"start"}),o.classList.add("highlighted"))}),200)}else if(o){const e=o[1].toLowerCase(),t=parseInt(o[2])-1,n=lang1Select.value;if(!n||!bibleCache[n])return;const a=bibleCache[n].find((t=>t.name.toLowerCase()===e||t.abbrev.toLowerCase()===e));if(!a)return;bookSelect.value=a.abbrev,localStorage.setItem("bookSelect",a.abbrev),populateChapterSelect(a),chapterSelect.value=t,localStorage.setItem("chapterSelect",t),onBookOrChapterChange()}}function bookSelectOnChange(){const e=bookSelect.value;localStorage.setItem("bookSelect",e);const t=lang1Select.value;if(!t||!bibleCache[t])return;const n=bibleCache[t].find((t=>t.abbrev===e));n&&(populateChapterSelect(n),chapterSelect.value=0,localStorage.setItem("chapterSelect",0),onBookOrChapterChange())}function chapterOnChange(){const e=chapterSelect.value;localStorage.setItem("chapterSelect",e),onBookOrChapterChange()}function togglePronunciationButtonOnClick(){pronunciationMode="jyutping"===pronunciationMode?"pinyin":"pinyin"===pronunciationMode?"both":"both"===pronunciationMode?"none":"jyutping",localStorage.setItem("pronunciationMode",pronunciationMode),updateToggleText(togglePronunciationButton,pronunciationLabels,pronunciationMode),onBookOrChapterChange()}function speakText(e,t){if(!window.speechSynthesis)return void alert("Your browser does not support text-to-speech.");(window.speechSynthesis.speaking||window.speechSynthesis.pending)&&window.speechSynthesis.cancel(),"zh_cuv"==t&&(e=e.replace(/\s+/g,""));const n=new SpeechSynthesisUtterance(e);n.lang={"zh-HK":"zh-HK",zh_cuv:"zh-CN",zh_ncv:"zh-CN",en_kjv:"en-US",en_bbe:"en-US",es_rvr:"es-ES",fr_apee:"fr-FR",de_schlachter:"de-DE",ru_synodal:"ru-RU",ko_ko:"ko-KR",vi_vietnamese:"vi-VN",pt_aa:"pt-PT",pt_acf:"pt-BR",pt_nvi:"pt-BR",el_greek:"el-GR",ar_svd:"ar-SA",eo_esperanto:"eo",fi_finnish:"fi-FI",fi_pr:"fi-FI",ro_cornilescu:"ro-RO"}[t]||"en-US";const o=window.speechSynthesis.getVoices().find((e=>e.lang===n.lang));o&&(n.voice=o),window.speechSynthesis.speak(n)}function copyPermalinkOnClick(){const e=lang1Select.value,t=lang2Select.value,n=lang3Select.value,o=bookSelect.value,a=parseInt(chapterSelect.value)+1,l=localStorage.getItem("selectedVerse"),c=new URL(window.location.href);c.searchParams.set("lang1",e),t&&c.searchParams.set("lang2",t),n&&c.searchParams.set("lang3",n),c.searchParams.set("book",o),c.searchParams.set("chapter",a),l&&c.searchParams.set("verse",l),navigator.clipboard.writeText(c.toString()).then((()=>alert("Link copied to clipboard!"))).catch((e=>console.error("Copy failed",e)))}function updateLayoutToggle(){updateToggleText(layoutToggleBtn,layoutLabels,isHorizontal?"horizontal":"side"),isHorizontal?bibleTable.classList.add("horizontal-layout"):bibleTable.classList.remove("horizontal-layout")}function layoutToggleBtnOnClick(){isHorizontal=!isHorizontal;let e=isHorizontal?"horizontal":"side";localStorage.setItem("layoutMode",e),updateLayoutToggle()}function filterToggleOnClick(){filterPopup?.classList.toggle("show")}function themeToggleOnClick(){currentTheme="dark"===currentTheme?"light":"dark",localStorage.setItem("theme",currentTheme),applyTheme(currentTheme)}function applyTheme(e){document.documentElement.setAttribute("data-theme",e),updateToggleText(themeToggle,themeLabels,e)}function updateToggleText(e,t,n){e.textContent=t[n]}applyTheme(currentTheme),updateLayoutToggle(),updateToggleText(togglePronunciationButton,pronunciationLabels,pronunciationMode),populateSelectors(),selects.forEach((e=>{const t=localStorage.getItem(e);t&&(document.getElementById(e).value=t)})),window.speechSynthesis.onvoiceschanged=()=>{window.speechSynthesis.getVoices()},applyQueryParams(),loadBibleData(),selects.forEach((e=>{const t=document.getElementById(e);t.addEventListener("change",(()=>{localStorage.setItem(e,t.value),loadBibleData()}))})),themeToggle?.addEventListener("click",themeToggleOnClick),bookSelect.addEventListener("change",bookSelectOnChange),chapterSelect.addEventListener("change",chapterOnChange),togglePronunciationButton.addEventListener("click",togglePronunciationButtonOnClick),copyPermalink.addEventListener("click",copyPermalinkOnClick),jumpBtn.addEventListener("click",jumpToVerse),layoutToggleBtn.addEventListener("click",layoutToggleBtnOnClick),filterToggle?.addEventListener("click",filterToggleOnClick),document?.addEventListener("click",(e=>{filterPopup?.contains(e.target)||filterToggle?.contains(e.target)||filterPopup?.classList.remove("show")}));